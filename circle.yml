machine:
  timezone:
    Europe/Dublin
  environment:
    SBT_VERSION: "0.13.13"
  services:
    - docker

dependencies:
  cache_directories:
    - "~/.ivy2"
    - "~/.sbt"
    - "target/resolution-cache"
    - "target/streams"
    - "project/target/resolution-cache"
    - "project/target/streams"
  pre:
    - wget -q https://dl.bintray.com/sbt/debian/sbt-"$SBT_VERSION".deb
    - sudo dpkg -i sbt-"$SBT_VERSION".deb
  override:
    # pull image from ecr to cache docker layers for quicker rebuilds
    - eval $(aws ecr get-login --region $AWS_REGION)
    - docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${CIRCLE_PROJECT_REPONAME}:latest

    - sbt docker:publishLocal

test:
  pre:
    - sbt scalastyle
  override:
    - sbt test

deployment:
  development:
    branch: master
    commands:
      - ./scripts/registry.sh
      - ./scripts/deploy_development.sh

machine:
  timezone:
    Europe/Dublin
  services:
    - docker
  environment:
    SBT_VERSION: "0.13.13"
    DOCKER_REGISTRY: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${CIRCLE_PROJECT_REPONAME}"

dependencies:
  pre:
    - wget -q https://dl.bintray.com/sbt/debian/sbt-"$SBT_VERSION".deb
    - sudo dpkg -i sbt-"$SBT_VERSION".deb
  override:
    - sbt docker:publishLocal
    - eval $(aws ecr get-login --region $AWS_REGION)
    - docker tag $CIRCLE_PROJECT_REPONAME:latest $DOCKER_REGISTRY:latest
    - docker push $DOCKER_REGISTRY:latest
  cache_directories:
    - "~/.ivy2"
    - "~/.sbt"
    - "target/resolution-cache"
    - "target/streams"
    - "project/target/resolution-cache"
    - "project/target/streams"

test:
  pre:
    - sbt scalastyle
  override:
    - sbt test
